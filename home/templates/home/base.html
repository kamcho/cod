{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Elite Tournaments | Call of Duty Gaming Kenya{% endblock %}</title>
    <meta name="description"
        content="Join Elite Tournaments, Kenya's premier Call of Duty competitive platform. Participate in Squad, Duo, and Solo COD Mobile tournaments. Win big and join a thriving gaming community.">
    <meta name="keywords"
        content="Kenya COD gamers, Call of Duty Tournaments Kenya, COD Mobile Competition Nairobi, Elite Tournaments Africa, Kenya Gaming Community, COD Tournaments East Africa, Gaming in Kenya">
    <meta name="author" content="Elite Tournaments HQ">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:title" content="Elite Tournaments | The Peak of Kenya COD Competition">
    <meta property="og:description"
        content="Deploy with the best. Elite Tournaments offers the most competitive Call of Duty experience in Kenya. Join a squad today.">
    <meta property="og:image" content="{% static 'img/og-image.jpg' %}">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="{{ request.build_absolute_uri }}">
    <meta property="twitter:title" content="Elite Tournaments | Kenya's COD Arena">
    <meta property="twitter:description"
        content="Compete in professional Call of Duty tournaments across Kenya. Fast payments, fair brackets, elite competition.">
    <meta property="twitter:image" content="{% static 'img/og-image.jpg' %}">

    <link rel="canonical" href="{{ request.build_absolute_uri }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#38bdf8',
                        'primary-hover': '#0ea5e9',
                        secondary: '#818cf8',
                        dark: '#0f172a',
                        'dark-card': '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer components {
            .glass {
                @apply bg-slate-900/60 backdrop-blur-xl border border-white/10;
            }
            .btn-outline {
                @apply px-4 py-2 border border-primary text-primary font-semibold rounded-lg hover:bg-primary/10 transition-all duration-300;
            }
        }

        @keyframes pulse-primary {
            0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
            100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
        }

        .notif-badge-pulse {
            animation: pulse-primary 2s infinite;
        }

        body {
            @apply bg-[#0f172a] text-slate-50 overflow-x-hidden;
        }
    </style>

    {% block extra_head %}{% endblock %}
    {% block extra_css %}{% endblock %}
</head>

<body class="min-h-screen">
    {% block navbar %}
    <nav class="fixed top-0 left-0 w-full z-50 h-20 glass border-b border-white/5 flex items-center transition-all duration-300"
        id="mainNav">
        <div class="max-w-7xl mx-auto w-full flex items-center justify-between px-6 lg:px-8">
            <a href="{% url 'home' %}" class="text-xl font-black tracking-wider flex items-center gap-3 group">
                <i class="fas fa-crosshairs text-primary group-hover:rotate-90 transition-transform duration-500"></i>
                <span class="bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">ELITE</span>
                TOURNAMENTS
            </a>

            <div class="hidden md:flex items-center gap-4">
                {% if user.is_authenticated %}
                <a href="{% url 'dashboard' %}"
                    class="text-sm font-semibold px-4 py-2 rounded-full transition-all duration-300 {% if request.resolver_match.url_name == 'dashboard' %}text-primary bg-primary/10{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-home mr-1"></i> Dashboard
                </a>
                <a href="{% url 'leaderboard' %}"
                    class="text-sm font-semibold px-4 py-2 rounded-full transition-all duration-300 {% if request.resolver_match.url_name == 'leaderboard' %}text-primary bg-primary/10{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-trophy mr-1"></i> Leaderboard
                </a>
                <a href="{% url 'recruitment_center' %}"
                    class="text-sm font-semibold px-4 py-2 rounded-full transition-all duration-300 {% if request.resolver_match.url_name == 'recruitment_center' %}text-primary bg-primary/10{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-users-rays mr-1"></i> Recruitment
                </a>
                <a href="{% url 'notifications' %}"
                    class="relative text-sm font-semibold px-4 py-2 rounded-full transition-all duration-300 {% if request.resolver_match.url_name == 'notifications' %}text-primary bg-primary/10{% else %}text-slate-400 hover:text-white hover:bg-white/5{% endif %}">
                    <i class="fas fa-bell"></i>
                    {% if unread_count > 0 %}
                    <span
                        class="absolute -top-1 -right-1 min-w-[18px] h-[18px] px-1 bg-primary text-slate-950 text-[10px] font-black rounded-full border-2 border-[#0f172a] flex items-center justify-center">
                        {{ unread_count }}
                    </span>
                    {% endif %}
                </a>

                <div class="w-px h-5 bg-white/10 mx-2"></div>

                {% if user.is_staff %}
                <a href="{% url 'admin_dashboard' %}"
                    class="text-sm font-semibold px-4 py-2 rounded-full text-secondary hover:bg-secondary/10 transition-all duration-300">
                    <i class="fas fa-shield-halved mr-1"></i> HQ
                </a>
                {% endif %}

                <a href="{% url 'profile' %}"
                    class="text-sm font-semibold px-4 py-2 rounded-full text-slate-400 hover:text-white hover:bg-white/5 transition-all duration-300">
                    <i class="fas fa-user-circle mr-1"></i> Profile
                </a>
                <a href="{% url 'logout' %}"
                    class="text-slate-400 hover:text-red-500 px-3 transition-colors duration-300">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
                {% else %}
                <a href="{% url 'login' %}" class="text-sm font-semibold text-slate-400 hover:text-white mr-4">Login</a>
                <a href="{% url 'register' %}"
                    class="bg-primary hover:bg-primary-hover text-slate-900 text-sm font-bold px-6 py-2 rounded-full transition-all duration-300 shadow-lg shadow-primary/20">Enlist
                    Now</a>
                {% endif %}
            </div>

            <!-- Mobile Toggle -->
            <button class="md:hidden text-slate-400 hover:text-white" id="mobile-toggle">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>

        <!-- Mobile Menu Container -->
        <div id="mobile-menu"
            class="hidden fixed top-20 left-0 w-full h-[calc(100vh-5rem)] glass border-t border-white/5 z-40 overflow-y-auto animate-in slide-in-from-top-full duration-300">
            <div class="p-6 flex flex-col gap-6">
                {% if user.is_authenticated %}
                <div class="flex flex-col gap-4">
                    <a href="{% url 'dashboard' %}"
                        class="flex items-center gap-3 text-lg font-bold text-slate-300 hover:text-primary transition-colors">
                        <i class="fas fa-home w-8 text-primary"></i> Dashboard
                    </a>
                    <a href="{% url 'leaderboard' %}"
                        class="flex items-center gap-3 text-lg font-bold text-slate-300 hover:text-primary transition-colors">
                        <i class="fas fa-trophy w-8 text-primary"></i> Leaderboard
                    </a>
                    <a href="{% url 'recruitment_center' %}"
                        class="flex items-center gap-3 text-lg font-bold text-slate-300 hover:text-primary transition-colors">
                        <i class="fas fa-users-rays w-8 text-primary"></i> Recruitment
                    </a>
                    <a href="{% url 'notifications' %}"
                        class="flex items-center gap-3 text-lg font-bold text-slate-300 hover:text-primary transition-colors">
                        <i class="fas fa-bell w-8 text-primary"></i> Notifications
                        {% if unread_count > 0 %}
                        <span class="bg-primary text-slate-950 text-[10px] font-black px-2 py-0.5 rounded-full">{{
                            unread_count }}</span>
                        {% endif %}
                    </a>
                </div>

                <div class="h-px bg-white/5 w-full my-2"></div>

                <div class="flex flex-col gap-4">
                    {% if user.is_staff %}
                    <a href="{% url 'admin_dashboard' %}"
                        class="flex items-center gap-3 text-lg font-bold text-secondary">
                        <i class="fas fa-shield-halved w-8"></i> Staff HQ
                    </a>
                    {% endif %}
                    <a href="{% url 'profile' %}" class="flex items-center gap-3 text-lg font-bold text-slate-300">
                        <i class="fas fa-user-circle w-8"></i> My Profile
                    </a>
                    <a href="{% url 'logout' %}" class="flex items-center gap-3 text-lg font-bold text-red-400">
                        <i class="fas fa-sign-out-alt w-8"></i> Sign Out
                    </a>
                </div>
                {% else %}
                <div class="flex flex-col gap-4">
                    <a href="{% url 'login' %}"
                        class="w-full py-4 text-center font-bold text-white glass rounded-2xl">Login</a>
                    <a href="{% url 'register' %}"
                        class="w-full py-4 text-center font-bold text-slate-950 bg-primary rounded-2xl shadow-xl shadow-primary/20">Enlist
                        Now</a>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>
    {% endblock %}

    {% if messages %}
    <div class="fixed top-24 right-8 z-[60] flex flex-col gap-3 w-[350px]">
        {% for message in messages %}
        <div
            class="glass p-4 pr-6 rounded-xl flex items-center gap-4 border-l-4 shadow-2xl animate-in slide-in-from-right-full duration-300 flash-message
            {% if message.tags == 'success' %}border-l-green-500 text-green-400{% elif message.tags == 'error' %}border-l-red-500 text-red-400{% else %}border-l-primary text-primary{% endif %}">
            <i
                class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} text-lg"></i>
            <span class="text-sm font-semibold text-white">{{ message }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <main class="pt-32 pb-20 {% block main_class %}container mx-auto px-4 lg:px-8{% endblock %}">
        {% block content %}{% endblock %}
    </main>

    <!-- Support Hub -->
    <div class="fixed bottom-6 right-6 z-[100] flex flex-col items-end gap-4">
        <!-- Support Menu -->
        <div id="support-menu" class="hidden flex flex-col gap-3 mb-2 animate-in slide-in-from-bottom-5 duration-300">
            <!-- WhatsApp Option -->
            <a href="https://wa.me/254742134431?text=hey,%20how%20do%20i%20join%20cod%20competition" target="_blank"
                class="flex items-center gap-3 glass px-4 py-3 rounded-2xl border-white/10 hover:bg-green-500/10 hover:border-green-500/50 transition-all group/wa shadow-2xl">
                <div
                    class="w-10 h-10 bg-[#25D366] text-white rounded-xl flex items-center justify-center shadow-lg shadow-green-500/20">
                    <i class="fab fa-whatsapp text-xl"></i>
                </div>
                <div class="flex flex-col">
                    <span
                        class="text-[10px] font-black text-slate-500 uppercase tracking-widest leading-none mb-1">Human
                        Intelligence</span>
                    <span class="text-sm font-bold text-white group-hover/wa:text-[#25D366] transition-colors">WhatsApp
                        Support</span>
                </div>
            </a>

            <!-- AI Strategist Option -->
            <button onclick="toggleAIChat()"
                class="flex items-center gap-3 glass px-4 py-3 rounded-2xl border-white/10 hover:bg-primary/10 hover:border-primary/50 transition-all group/ai shadow-2xl">
                <div
                    class="w-10 h-10 bg-primary text-slate-950 rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <div class="flex flex-col items-start">
                    <span
                        class="text-[10px] font-black text-slate-500 uppercase tracking-widest leading-none mb-1">Tactical
                        AI</span>
                    <span
                        class="text-sm font-bold text-white group-hover/ai:text-primary transition-colors text-left">AI
                        Strategist</span>
                </div>
            </button>
        </div>

        <!-- Main Hub Toggle -->
        <button id="support-hub-toggle" onclick="toggleSupportHub()"
            class="w-14 h-14 bg-slate-900 border border-white/10 text-white rounded-2xl flex items-center justify-center shadow-2xl transition-all hover:scale-105 active:scale-95 group">
            <i class="fas fa-plus text-xl transition-transform duration-300" id="hub-icon"></i>
            <span
                class="absolute right-20 bg-slate-900 border border-white/10 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest text-white whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                Support Hub
            </span>
        </button>
    </div>

    {% include 'home/partials/ai_chat_widget.html' %}

    {% block extra_js %}{% endblock %}

    <script>
        // Navbar scroll effect
        window.addEventListener('scroll', () => {
            const nav = document.getElementById('mainNav');
            if (window.scrollY > 50) {
                nav.classList.add('h-16', 'bg-slate-950/90', 'backdrop-blur-2xl');
                nav.classList.remove('h-20');
            } else {
                nav.classList.add('h-20');
                nav.classList.remove('h-16', 'bg-slate-950/90', 'backdrop-blur-2xl');
            }
        });

        // Mobile Menu Toggle
        const mobileToggle = document.getElementById('mobile-toggle');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileToggle.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
            const icon = mobileToggle.querySelector('i');
            if (mobileMenu.classList.contains('hidden')) {
                icon.className = 'fas fa-bars text-xl';
            } else {
                icon.className = 'fas fa-times text-xl';
            }
        });

        // Close mobile menu on resize if screen becomes large
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) {
                mobileMenu.classList.add('hidden');
                mobileToggle.querySelector('i').className = 'fas fa-bars text-xl';
            }
        });

        // Auto-hide flash messages after 5 seconds
        setTimeout(function () {
            const messages = document.querySelectorAll('.flash-message');
            messages.forEach(msg => {
                msg.style.transition = 'all 0.5s ease';
                msg.style.opacity = '0';
                msg.style.transform = 'translateX(50px)';
                setTimeout(() => msg.remove(), 500);
            });
        }, 5000);

        // Support Hub Logic
        function toggleSupportHub() {
            const menu = document.getElementById('support-menu');
            const icon = document.getElementById('hub-icon');
            menu.classList.toggle('hidden');
            if (!menu.classList.contains('hidden')) {
                icon.style.transform = 'rotate(45deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // AI Chat Logic
        let chatHistory = [];

        function toggleAIChat() {
            const window = document.getElementById('ai-chat-window');
            window.classList.toggle('hidden');
            if (!window.classList.contains('hidden')) {
                document.getElementById('ai-chat-input').focus();
                // Close support hub if open
                const menu = document.getElementById('support-menu');
                if (!menu.classList.contains('hidden')) {
                    toggleSupportHub();
                }
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message to UI
            addChatMessage('user', message);
            input.value = '';

            // Add to history
            chatHistory.push({ role: 'user', content: message });

            // Show typing indicator
            const typingId = addChatTypingIndicator();

            try {
                const response = await fetch('/ai-chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ messages: chatHistory })
                });

                const data = await response.json();

                // Remove typing indicator
                document.getElementById(typingId).remove();

                if (data.response) {
                    addChatMessage('assistant', data.response);
                    chatHistory.push({ role: 'assistant', content: data.response });
                } else {
                    addChatMessage('assistant', 'Sorry, I encountered an internal error. Please try again.');
                }
            } catch (error) {
                document.getElementById(typingId).remove();
                addChatMessage('assistant', 'Connection lost. Please check your uplink.');
            }
        }

        function addChatMessage(role, text) {
            const container = document.getElementById('ai-messages-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} max-w-[85%]`;

            const isAI = role === 'assistant';

            msgDiv.innerHTML = `
                <div class="p-4 rounded-2xl ${isAI ? 'rounded-tl-none glass border-primary/20 bg-primary/5' : 'rounded-tr-none bg-primary text-slate-950'} text-sm leading-relaxed">
                    ${text}
                </div>
                <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-2 ${isAI ? 'ml-1' : 'mr-1'}">${isAI ? 'Elite AI' : 'You'}</span>
            `;

            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addChatTypingIndicator() {
            const container = document.getElementById('ai-messages-container');
            const id = 'typing-' + Date.now();
            const msgDiv = document.createElement('div');
            msgDiv.id = id;
            msgDiv.className = 'flex flex-col items-start max-w-[85%] animate-pulse';
            msgDiv.innerHTML = `
                <div class="p-4 rounded-2xl rounded-tl-none glass border-white/5 bg-white/5 text-xs text-slate-500 italic">
                    Elite AI is thinking...
                </div>
            `;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            return id;
        }
    </script>
</body>

</html>